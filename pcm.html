<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KEDCO PC&M ‚Äî Live Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#062913;        /* dark green */
      --panel:#0b3d20;     /* deep panel */
      --gold:#ffd44d;      /* gold accent */
      --text:#eef6ea;      /* light text */
      --muted:#b9c8b3;
      --accent:#13b36b;
      --primary:#13b36b;   /* Updated to match accent */
      --secondary:#0b3d20; /* Updated to match panel */
      --danger:#dc3545;
      --warning:#ffc107;
      --info:#17a2b8;
      --radius:14px;
      --shadow: 0 12px 30px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter,system-ui,Arial,sans-serif; background:linear-gradient(180deg,var(--bg), #041a10); color:var(--text);}
    .container{min-height:100vh; display:grid; grid-template-rows:auto 1fr auto;}

    /* TOP HEADER */
    .top-header{
      background:linear-gradient(90deg,var(--panel), #08341c);
      padding:12px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:var(--shadow);
      gap:12px;
    }
    .top-left{display:flex;align-items:center;gap:12px}
    .top-left .logo{width:44px;height:44px;border-radius:8px;background:conic-gradient(from 150deg, var(--gold), #fff2b0);box-shadow:0 6px 18px rgba(0,0,0,.35)}
    .top-header h2{margin:0;font-size:18px;font-weight:800;color:var(--gold)}
    .logout-btn{
      background:linear-gradient(90deg, #e74c3c, #ff6b6b);
      border:none;
      padding:8px 14px;
      border-radius:8px;
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    .logout-btn:hover{opacity:0.9}

    .app{display:grid; grid-template-columns:300px 1fr; gap:20px; padding:22px}

    /* SIDEBAR */
    aside{background:linear-gradient(180deg,var(--panel), #082a18); padding:20px; border-radius:12px; border:1px solid rgba(255,255,255,.03); box-shadow:var(--shadow); position:sticky; top:20px; height:calc(100vh - 140px)}
    .brand{display:flex; align-items:center; gap:12px}
    .brand h1{font-size:16px;margin:0}
    nav{margin-top:20px; display:flex; flex-direction:column; gap:8px}
    .nav-btn{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.03);background:transparent;color:var(--text);cursor:pointer;transition:all .14s}
    .nav-btn:hover{transform:translateY(-3px); box-shadow:0 8px 18px rgba(0,0,0,.35)}
    .nav-btn.active{background:linear-gradient(90deg, rgba(255,212,77,.06), rgba(19,179,107,.03));border-color:rgba(255,212,77,.12)}
    .nav-ic{width:24px;text-align:center}
    .sidebar-foot{position:absolute;bottom:20px;left:20px;right:20px;font-size:12px;color:var(--muted)}

    /* MAIN */
    main{padding:6px 0}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .hdr-left{display:flex;align-items:center;gap:12px}
    .live-badge{background:var(--gold);color:#05210d;padding:6px 10px;border-radius:999px;font-weight:700}
    .clock{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px}
    .btn{padding:10px 14px;border-radius:10px;border:0;background:transparent;color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(90deg, var(--accent), #2ed88e); color:#05210d; font-weight:700}

    /* GRID + CARDS */
    .grid{display:grid;gap:16px}
    .cards{grid-template-columns:repeat(3,1fr)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));padding:16px;border-radius:var(--radius);border:1px solid rgba(255,255,255,.04);box-shadow:var(--shadow)}
    .kpi{font-size:26px;font-weight:800}
    .muted{color:var(--muted)}

    /* TABLES */
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.03);text-align:left}
    th{color:var(--muted);font-weight:700}
    .status{padding:6px 10px;border-radius:999px;font-weight:700}
    .status.ok{background:rgba(19,179,107,.12);color:#8ef0b9}
    .status.warn{background:rgba(255,212,77,.12);color:#ffe9a8}
    .status.bad{background:rgba(231,76,60,.12);color:#ffb1ac}

    .actions{display:flex;gap:8px}
    .pill{padding:8px 10px;border-radius:999px;border:0;cursor:pointer}
    .pill.approve{background:rgba(19,179,107,.12);color:var(--accent);font-weight:700}
    .pill.reject{background:rgba(231,76,60,.12);color:#ff7b7b;font-weight:700}
    .pill.assign{background:rgba(255,212,77,.08);color:var(--gold);font-weight:700}

    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}

    /* TEST EQUIPMENT STYLES (from Code 1) */
    .test-categories {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .category-card {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        box-shadow: var(--shadow);
        padding: 20px;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
        border-top: 4px solid var(--accent);
        text-align: center;
    }
    .category-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        background: rgba(255,255,255,0.08);
    }
    .category-card i {
        font-size: 36px;
        color: var(--gold);
        margin-bottom: 15px;
    }
    .category-card h3 {
        margin-bottom: 10px;
        color: var(--gold);
    }
    .category-card p {
        color: var(--muted);
        font-size: 14px;
    }
    .test-selection {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        box-shadow: var(--shadow);
        padding: 25px;
        margin-bottom: 30px;
        display: none;
    }
    .test-selection.active {
        display: block;
    }
    .test-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    .test-item {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        padding: 15px;
        border-left: 4px solid var(--accent);
        cursor: pointer;
        transition: all 0.3s;
    }
    .test-item:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-3px);
        background: rgba(255,255,255,0.08);
    }
    .test-item h4 {
        color: var(--gold);
        margin-bottom: 10px;
    }
    .test-item p {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 10px;
    }
    .test-item .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    .badge { background-color: rgba(19,179,107,0.2); color: var(--accent); }
    .badge-oil { background-color: rgba(255,212,77,0.2); color: var(--gold); }
    .badge-advanced { background-color: rgba(101, 126, 255, 0.2); color: #657eff; }
    .badge-functional { background-color: rgba(0, 151, 167, 0.2); color: #00bcd4; }
    .badge-hv { background-color: rgba(220, 53, 69, 0.2); color: var(--danger); }
    .badge-basic { background-color: rgba(123, 31, 162, 0.2); color: #9c27b0; }

    .test-form, .test-report {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        box-shadow: var(--shadow);
        padding: 25px;
        display: none;
        border: 1px solid rgba(255,255,255,0.05);
    }
    .test-form.active, .test-report.active {
        display: block;
    }
    .form-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .form-header h3 {
        color: var(--gold);
        margin-bottom: 5px;
    }
    .form-header p {
        color: var(--muted);
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text);
    }
    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 5px;
        font-size: 14px;
        transition: border-color 0.3s;
        background: rgba(0,0,0,0.2);
        color: var(--text);
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        border-color: var(--accent);
        outline: none;
    }
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 30px;
    }
    .btn-test {
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .btn-test i {
        margin-right: 8px;
    }
    .btn-primary {
        background-color: var(--accent);
        color: #05210d;
    }
    .btn-primary:hover {
        background-color: #2ed88e;
    }
    .btn-outline {
        background-color: transparent;
        border: 1px solid rgba(255,255,255,0.1);
        color: var(--text);
    }
    .btn-outline:hover {
        background-color: rgba(255,255,255,0.05);
    }
    .report-header {
        text-align: center;
        margin-bottom: 30px;
    }
    .report-header h3 {
        color: var(--gold);
        font-size: 24px;
        margin-bottom: 10px;
    }
    .report-header p {
        color: var(--muted);
    }
    .report-details table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 30px;
    }
    .report-details th, .report-details td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .report-details th {
        background-color: rgba(255,255,255,0.05);
        color: var(--gold);
        font-weight: 600;
        width: 30%;
    }
    .report-results h4 {
        color: var(--gold);
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .result-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px dashed rgba(255,255,255,0.05);
    }
    .result-item:last-child {
        border-bottom: none;
    }
    .result-label {
        font-weight: 600;
        color: var(--text);
    }
    .result-value {
        color: var(--muted);
    }
    .report-conclusion {
        background-color: rgba(255,255,255,0.05);
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 30px;
    }
    .report-conclusion h4 {
        color: var(--gold);
        margin-bottom: 10px;
    }
    .report-status {
        text-align: center;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 30px;
        font-weight: 600;
        font-size: 18px;
    }
    .status-pass {
        background-color: rgba(40, 167, 69, 0.1);
        color: var(--accent);
        border: 1px solid var(--accent);
    }
    .status-fail {
        background-color: rgba(220, 53, 69, 0.1);
        color: var(--danger);
        border: 1px solid var(--danger);
    }
    .report-actions {
        display: flex;
        justify-content: center;
        gap: 15px;
    }
    .back-btn {
        margin-bottom: 20px;
        cursor: pointer;
        color: var(--gold);
        font-weight: 600;
        display: inline-flex;
        align-items: center;
    }
    .back-btn i {
        margin-right: 8px;
    }
    .hidden {
        display: none;
    }

    /* Print-Specific Styles */
    @media print {
        .no-print, .no-print * {
            display: none !important;
        }
        body * {
            visibility: hidden;
        }
        .test-report, .test-report * {
            visibility: visible;
        }
        .test-report {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            box-shadow: none;
            border: 1px solid #ccc;
        }
        .report-actions {
            display: none;
        }
        .back-btn {
            display: none;
        }
    }

    @media (max-width: 1100px) { 
        .cards{grid-template-columns:repeat(2,1fr)} 
        .app{grid-template-columns:1fr} 
        aside{position:relative;height:auto} 
        .test-categories, .test-list {
            grid-template-columns: 1fr 1fr;
        }
    }
    @media (max-width: 700px) { 
        .cards{grid-template-columns:1fr} 
        header{flex-direction:column;align-items:flex-start} 
        .app{padding:12px} 
        .top-header{flex-direction:column;gap:8px} 
        aside{height:auto} 
        .test-categories, .test-list, .form-row {
            grid-template-columns: 1fr;
        }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-header">
      <div class="top-left">
        <div class="logo"></div>
        <div>
          <div style="font-weight:700;color:var(--muted);font-size:12px">Kano Electricity Distribution Company</div>
          <h2>KEDCO PC&M Unit ‚Äî Live Dashboard</h2>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <div id="topClock" class="clock" style="min-width:220px;text-align:right"></div>
        <button class="logout-btn" onclick="window.location.href='index.html'">Logout</button>
      </div>
    </div>

    <div class="app">
      <aside>
        <div class="brand"><div class="logo" style="width:36px;height:36px"></div><h1>KEDCO PC&M</h1></div>
        <nav>
          <button class="nav-btn active" data-target="overview"><span class="nav-ic">üè†</span> Overview</button>
          <button class="nav-btn" data-target="protection"><span class="nav-ic">üõ°Ô∏è</span> Protection</button>
          <button class="nav-btn" data-target="control"><span class="nav-ic">üéõÔ∏è</span> Control</button>
          <button class="nav-btn" data-target="metering"><span class="nav-ic">üìè</span> Metering</button>
          <button class="nav-btn" data-target="equipment"><span class="nav-ic">üß∞</span> Test Equipment</button>
          <button class="nav-btn" data-target="trouble"><span class="nav-ic">üö®</span> Trouble Reports</button>
          <button class="nav-btn" data-target="tryreq"><span class="nav-ic">üîÅ</span> Transformer Try Requests</button>
          <div style="height:8px"></div>
          <button class="nav-btn" id="toggleSound"><span class="nav-ic">üîä</span> Sound: ON</button>
          <button class="nav-btn" id="simulate">Simulate Events</button>
        </nav>
        <div class="sidebar-foot">¬© <span id="year"></span> <br></div>
      </aside>

      <main>
        <header>
          <div class="hdr-left">
            <div class="live-badge">LIVE</div>
            <div>
              <div style="font-weight:800">Protection, Control & Metering ‚Äî Live Dashboard</div>
              <div id="clock" class="clock">‚Äî</div>
            </div>
          </div>
          <div class="controls">
            <input id="globalSearch" placeholder="Search (feeder, region, request)" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:transparent;color:var(--text)">
            <button class="btn primary" id="btnSim">+ New Sample</button>
          </div>
        </header>

        <!-- OVERVIEW -->
        <section id="overview" class="view">
          <div class="grid cards">
            <div class="card"><div class="muted">Healthy Feeders</div><div class="kpi" id="kpiHealthy">‚Äî</div></div>
            <div class="card"><div class="muted">Open Incidents</div><div class="kpi" id="kpiIncidents">‚Äî</div></div>
            <div class="card"><div class="muted">Pending Actions</div><div class="kpi" id="kpiPending">‚Äî</div></div>
          </div>
          <div class="grid" style="grid-template-columns:1fr 420px;gap:16px;margin-top:16px">
            <div class="card"><div class="muted">Protection Trips (recent)</div><canvas id="chartTrips" style="max-height:260px"></canvas></div>
            <div class="card"><div class="muted">Equipment Availability</div><canvas id="chartEquip" style="max-height:260px"></canvas></div>
          </div>

          <div class="grid" style="grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
            <div class="card"><div class="muted">Incident Severity (Live)</div><canvas id="chartSeverity" style="max-height:260px"></canvas></div>
            <div class="card"><div class="muted">Trouble Reports by Region</div><canvas id="chartRegion" style="max-height:260px"></canvas></div>
          </div>
        </section>

        <!-- PROTECTION -->
        <section id="protection" class="view" style="display:none">
          <div class="card"><div class="muted">Protection Events</div>
            <table id="tblProtection"><thead><tr><th>Time</th><th>Feeder</th><th>Device</th><th>Event</th><th>Status</th></tr></thead><tbody></tbody></table>
          </div>
        </section>

        <!-- CONTROL -->
        <section id="control" class="view" style="display:none">
          <div class="card"><div class="muted">Control Actions</div>
            <table id="tblControl"><thead><tr><th>Time</th><th>Location</th><th>Action</th><th>Operator</th><th>Status</th></tr></thead><tbody></tbody></table>
          </div>
        </section>

        <!-- METERING -->
        <section id="metering" class="view" style="display:none">
          <div class="card"><div class="muted">Meter Tests</div>
            <table id="tblMetering"><thead><tr><th>Time</th><th>Meter</th><th>Customer</th><th>Test</th><th>Result</th></tr></thead><tbody></tbody></table>
          </div>
        </section>

        <!-- EQUIPMENT -->
        <section id="equipment" class="view" style="display:none">
          <!-- Dashboard View -->
          <div id="dashboard-view">
            <div class="page-header">
              <h2><i class="fas fa-tachometer-alt"></i> Testing Dashboard</h2>
              <div class="page-actions">
                <button id="new-test-btn" class="btn primary"><i class="fas fa-plus"></i> New Test</button>
              </div>
            </div>
            <div class="test-categories">
              <div class="category-card" data-category="transformers">
                <i class="fas fa-transformer"></i>
                <h3>Transformers</h3>
                <p>Insulation, ratio, winding tests and more</p>
              </div>
              <div class="category-card" data-category="breakers">
                <i class="fas fa-plug"></i>
                <h3>Circuit Breakers</h3>
                <p>Contact resistance, timing, insulation tests</p>
              </div>
              <div class="category-card" data-category="meters">
                <i class="fas fa-tachometer-alt"></i>
                <h3>Energy Meters</h3>
                <p>Accuracy, starting current, creep tests</p>
              </div>
              <div class="category-card" data-category="cables">
                <i class="fas fa-ethernet"></i>
                <h3>Cables</h3>
                <p>Insulation, HV, continuity, phase tests</p>
              </div>
            </div>
            <div class="recent-tests">
              <h3><i class="fas fa-history"></i> Recent Tests</h3>
              <p>No recent tests available</p>
            </div>
          </div>

          <!-- Test Category Selection -->
          <div id="test-category-view" class="hidden">
            <div class="back-btn" id="back-to-dashboard">
              <i class="fas fa-arrow-left"></i> Back to Dashboard
            </div>
            <div class="test-selection active" id="transformers-tests">
              <h3><i class="fas fa-transformer"></i> Transformer Tests</h3>
              <p>Select a test to perform on the transformer</p>
              <div class="test-list">
                <div class="test-item" data-test="ir-test">
                  <h4>Insulation Resistance Test</h4>
                  <p>Assess insulation between windings and earth</p>
                  <span class="badge">Standard Test</span>
                </div>
                <div class="test-item" data-test="ttr-test">
                  <h4>Turns Ratio Test (TTR)</h4>
                  <p>Confirm winding ratio matches nameplate</p>
                  <span class="badge">Standard Test</span>
                </div>
                <div class="test-item" data-test="winding-test">
                  <h4>Winding Resistance Test</h4>
                  <p>Detect shorted turns or loose connections</p>
                  <span class="badge">Standard Test</span>
                </div>
                <div class="test-item" data-test="oil-test">
                  <h4>Oil Dielectric Strength Test</h4>
                  <p>Evaluate transformer oil's insulation quality</p>
                  <span class="badge badge-oil">Oil Analysis</span>
                </div>
                <div class="test-item" data-test="excitation-test">
                  <h4>Magnetization/Excitation Test</h4>
                  <p>Detect core problems like saturation</p>
                  <span class="badge badge-advanced">Advanced Test</span>
                </div>
                <div class="test-item" data-test="vector-test">
                  <h4>Vector Group Test</h4>
                  <p>Verify phase displacement and grouping</p>
                  <span class="badge badge-advanced">Advanced Test</span>
                </div>
              </div>
            </div>
            <div class="test-selection" id="breakers-tests">
              <h3><i class="fas fa-plug"></i> Circuit Breaker Tests</h3>
              <p>Select a test to perform on the circuit breaker</p>
              <div class="test-list">
                <div class="test-item" data-test="contact-resistance">
                  <h4>Contact Resistance Test</h4>
                  <p>Measure resistance across closed contacts</p>
                  <span class="badge">Standard Test</span>
                </div>
                <div class="test-item" data-test="timing-test">
                  <h4>Timing Test (Open/Close)</h4>
                  <p>Assess mechanical operation timing</p>
                  <span class="badge">Standard Test</span>
                </div>
                <div class="test-item" data-test="cb-ir-test">
                  <h4>Insulation Resistance Test</h4>
                  <p>Verify insulation between terminals and ground</p>
                  <span class="badge">Standard Test</span>
                </div>
                <div class="test-item" data-test="trip-test">
                  <h4>Trip Circuit Supervision Test</h4>
                  <p>Ensure trip circuit reliability</p>
                  <span class="badge badge-functional">Functional Test</span>
                </div>
                <div class="test-item" data-test="sf6-test">
                  <h4>SF6/Gas Pressure Check</h4>
                  <p>Ensure appropriate pressure in gas-insulated CBs</p>
                  <span class="badge badge-oil">Gas Analysis</span>
                </div>
              </div>
            </div>
            <div class="test-selection" id="meters-tests">
              <h3><i class="fas fa-tachometer-alt"></i> Energy Meter Tests</h3>
              <p>Select a test to perform on the energy meter</p>
              <div class="test-list">
                <div class="test-item" data-test="accuracy-test">
                  <h4>Accuracy Test</h4>
                  <p>Verify meter reading accuracy against known loads</p>
                  <span class="badge">Standard Test</span>
                </div>
                <div class="test-item" data-test="starting-test">
                  <h4>Starting Current Test</h4>
                  <p>Check if meter starts registering at low load current</p>
                  <span class="badge badge-functional">Functional Test</span>
                </div>
                <div class="test-item" data-test="creep-test">
                  <h4>Creep Test</h4>
                  <p>Check for movement without load</p>
                  <span class="badge badge-functional">Fraud Detection</span>
                </div>
              </div>
            </div>
            <div class="test-selection" id="cables-tests">
              <h3><i class="fas fa-ethernet"></i> Cable Tests</h3>
              <p>Select a test to perform on the cable</p>
              <div class="test-list">
                <div class="test-item" data-test="cable-ir-test">
                  <h4>Insulation Resistance Test</h4>
                  <p>Detect insulation degradation</p>
                  <span class="badge">Standard Test</span>
                </div>
                <div class="test-item" data-test="hi-pot-test">
                  <h4>High Voltage Test (Hi-Pot)</h4>
                  <p>Assess dielectric strength of insulation</p>
                  <span class="badge badge-hv">HV Test</span>
                </div>
                <div class="test-item" data-test="continuity-test">
                  <h4>Continuity Test</h4>
                  <p>Ensure conductors are not open-circuited</p>
                  <span class="badge badge-basic">Basic Test</span>
                </div>
                <div class="test-item" data-test="phase-id-test">
                  <h4>Phase Identification Test</h4>
                  <p>Verify phase sequence and identification</p>
                  <span class="badge badge-functional">Functional Test</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Test Form View -->
          <div id="test-form-view" class="hidden">
            <div class="back-btn" id="back-to-tests">
              <i class="fas fa-arrow-left"></i> Back to Tests
            </div>

            <!-- 1. Insulation Resistance Test Form -->
            <div class="test-form" id="ir-test-form">
              <div class="form-header">
                <h3><i class="fas fa-shield-alt"></i> Insulation Resistance Test</h3>
                <p>Assess the condition of insulation between transformer windings and earth</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="Megger insulation tester (5kV)" readonly>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Test Voltage (kV)</label>
                  <input type="number" id="ir-voltage" placeholder="e.g. 5.0">
                </div>
                <div class="form-group">
                  <label>Ambient Temperature (¬∞C)</label>
                  <input type="number" id="ir-temp" placeholder="e.g. 28">
                </div>
              </div>
              <h4>Measurement Values</h4>
              <div class="form-row">
                <div class="form-group">
                  <label>HV to Earth (MŒ©)</label>
                  <input type="number" id="ir-hv-earth" placeholder="e.g. 2500">
                </div>
                <div class="form-group">
                  <label>LV to Earth (MŒ©)</label>
                  <input type="number" id="ir-lv-earth" placeholder="e.g. 1800">
                </div>
              </div>
              <div class="form-group">
                <label>HV to LV (MŒ©)</label>
                <input type="number" id="ir-hv-lv" placeholder="e.g. 3200">
              </div>
              <div class="form-group">
                <label>Additional Notes</label>
                <input type="text" id="ir-notes" placeholder="e.g. Dry conditions, no moisture">
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-ir-test">Submit Test</button>
              </div>
            </div>

            <!-- 2. Turns Ratio Test Form -->
            <div class="test-form" id="ttr-test-form">
              <div class="form-header">
                <h3><i class="fas fa-sync-alt"></i> Turns Ratio Test (TTR)</h3>
                <p>Confirm that the winding ratio of the transformer is correct and as per the nameplate</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="Transformer Turns Ratio Tester" readonly>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Nominal Ratio</label>
                  <input type="text" id="ttr-nominal" placeholder="e.g. 11kV/415V">
                </div>
                <div class="form-group">
                  <label>Applied Voltage (V)</label>
                  <input type="number" id="ttr-voltage" placeholder="e.g. 415">
                </div>
              </div>
              <h4>Measured Values</h4>
              <div class="form-row">
                <div class="form-group">
                  <label>Primary Voltage (V)</label>
                  <input type="number" id="ttr-primary" placeholder="e.g. 11000">
                </div>
                <div class="form-group">
                  <label>Secondary Voltage (V)</label>
                  <input type="number" id="ttr-secondary" placeholder="e.g. 414">
                </div>
              </div>
              <div class="form-group">
                <label>Additional Notes</label>
                <input type="text" id="ttr-notes" placeholder="e.g. Within tolerance">
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-ttr-test">Submit Test</button>
              </div>
            </div>

            <!-- 3. Winding Resistance Test Form -->
            <div class="test-form" id="winding-test-form">
              <div class="form-header">
                <h3><i class="fas fa-microchip"></i> Winding Resistance Test</h3>
                <p>Detect shorted turns, loose connections, and contact problems</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="Micro-ohmmeter" readonly>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Ambient Temperature (¬∞C)</label>
                  <input type="number" id="winding-temp" placeholder="e.g. 25">
                </div>
              </div>
              <h4>Resistance per Phase (Œ©)</h4>
              <div class="form-row">
                <div class="form-group">
                  <label>HV-A</label>
                  <input type="number" id="winding-hv-a" step="0.01" placeholder="e.g. 2.1">
                </div>
                <div class="form-group">
                  <label>HV-B</label>
                  <input type="number" id="winding-hv-b" step="0.01" placeholder="e.g. 2.1">
                </div>
                <div class="form-group">
                  <label>HV-C</label>
                  <input type="number" id="winding-hv-c" step="0.01" placeholder="e.g. 2.2">
                </div>
              </div>
              <div class="form-group">
                <label>Additional Notes</label>
                <input type="text" id="winding-notes" placeholder="e.g. Balanced readings">
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-winding-test">Submit Test</button>
              </div>
            </div>

            <!-- 4. Oil Dielectric Strength Test Form -->
            <div class="test-form" id="oil-test-form">
              <div class="form-header">
                <h3><i class="fas fa-flask"></i> Oil Dielectric Strength Test</h3>
                <p>Evaluate transformer insulating oil's ability to withstand electrical stress</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="Oil BDV (Breakdown Voltage) Tester" readonly>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Temperature (¬∞C)</label>
                  <input type="number" id="oil-temp" placeholder="e.g. 25">
                </div>
              </div>
              <h4>Breakdown Voltage (kV)</h4>
              <div class="form-row">
                <div class="form-group">
                  <label>Test 1</label>
                  <input type="number" id="oil-test1" placeholder="e.g. 38">
                </div>
                <div class="form-group">
                  <label>Test 2</label>
                  <input type="number" id="oil-test2" placeholder="e.g. 42">
                </div>
                <div class="form-group">
                  <label>Test 3</label>
                  <input type="number" id="oil-test3" placeholder="e.g. 40">
                </div>
              </div>
              <div class="form-group">
                <label>Additional Notes</label>
                <input type="text" id="oil-notes" placeholder="e.g. Clean oil sample">
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-oil-test">Submit Test</button>
              </div>
            </div>

            <!-- 5. Excitation Test Form -->
            <div class="test-form" id="excitation-test-form">
              <div class="form-header">
                <h3><i class="fas fa-wave-square"></i> Magnetization/Excitation Test</h3>
                <p>Detect core problems like saturation or shorted laminations</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="Power analyzer" readonly>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Applied Voltage (V)</label>
                  <input type="number" id="excitation-voltage" placeholder="e.g. 230">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Excitation Current (A)</label>
                  <input type="number" id="excitation-current" step="0.01" placeholder="e.g. 1.5">
                </div>
                <div class="form-group">
                  <label>Core Loss (W)</label>
                  <input type="number" id="excitation-loss" placeholder="e.g. 110">
                </div>
              </div>
              <div class="form-group">
                <label>Additional Notes</label>
                <input type="text" id="excitation-notes" placeholder="e.g. No saturation observed">
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-excitation-test">Submit Test</button>
              </div>
            </div>

            <!-- 6. Vector Group Test Form -->
            <div class="test-form" id="vector-test-form">
              <div class="form-header">
                <h3><i class="fas fa-project-diagram"></i> Vector Group Test</h3>
                <p>Verify the phase displacement and correct vector grouping of windings</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="TTR with vector detection" readonly>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Measured Vector Group</label>
                  <input type="text" id="vector-group" placeholder="e.g. Dyn11">
                </div>
                <div class="form-group">
                  <label>Phase Shift (¬∞)</label>
                  <input type="number" id="vector-shift" placeholder="e.g. 30">
                </div>
              </div>
              <div class="form-group">
                <label>Additional Notes</label>
                <input type="text" id="vector-notes" placeholder="e.g. Matches nameplate">
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-vector-test">Submit Test</button>
              </div>
            </div>

            <!-- 7. Contact Resistance Test Form -->
            <div class="test-form" id="contact-resistance-form">
              <div class="form-header">
                <h3><i class="fas fa-bolt"></i> Contact Resistance Test</h3>
                <p>Measure resistance across closed contacts to identify erosion</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="Micro-ohmmeter" readonly>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Phase A (¬µŒ©)</label>
                  <input type="number" id="contact-a" placeholder="e.g. 35">
                </div>
                <div class="form-group">
                  <label>Phase B (¬µŒ©)</label>
                  <input type="number" id="contact-b" placeholder="e.g. 38">
                </div>
                <div class="form-group">
                  <label>Phase C (¬µŒ©)</label>
                  <input type="number" id="contact-c" placeholder="e.g. 37">
                </div>
              </div>
              <div class="form-group">
                <label>Additional Notes</label>
                <input type="text" id="contact-notes" placeholder="e.g. Contacts clean">
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-contact-test">Submit Test</button>
              </div>
            </div>

            <!-- 8. Timing Test Form -->
            <div class="test-form" id="timing-test-form">
              <div class="form-header">
                <h3><i class="fas fa-clock"></i> Timing Test (Open/Close)</h3>
                <p>Assess the mechanical operation timing of CBs</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="Circuit Breaker Analyzer" readonly>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Open Time (ms)</label>
                  <input type="number" id="timing-open" placeholder="e.g. 58">
                </div>
                <div class="form-group">
                  <label>Close Time (ms)</label>
                  <input type="number" id="timing-close" placeholder="e.g. 62">
                </div>
              </div>
              <div class="form-group">
                <label>Additional Notes</label>
                <input type="text" id="timing-notes" placeholder="e.g. No delay">
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-timing-test">Submit Test</button>
              </div>
            </div>

            <!-- 9. CB Insulation Test Form -->
            <div class="test-form" id="cb-ir-test-form">
              <div class="form-header">
                <h3><i class="fas fa-shield-alt"></i> Insulation Resistance Test (CB)</h3>
                <p>Verify insulation between terminals and ground</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="Megger (5kV)" readonly>
              </div>
              <div class="form-group">
                <label>Insulation Resistance (MŒ©)</label>
                <input type="number" id="cb-ir-value" placeholder="e.g. 1500">
              </div>
              <div class="form-group">
                <label>Additional Notes</label>
                <input type="text" id="cb-ir-notes" placeholder="e.g. Strong insulation">
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-cb-ir-test">Submit Test</button>
              </div>
            </div>

            <!-- 10. Trip Circuit Test Form -->
            <div class="test-form" id="trip-test-form">
              <div class="form-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Trip Circuit Supervision Test</h3>
                <p>Ensure trip circuit is reliable during fault conditions</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="Multimeter, Relay Test Set" readonly>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Trip Voltage (V DC)</label>
                  <input type="number" id="trip-voltage" value="110">
                </div>
                <div class="form-group">
                  <label>Trip Current (mA)</label>
                  <input type="number" id="trip-current" value="12">
                </div>
              </div>
              <div class="form-group">
                <label>Observations</label>
                <input type="text" id="trip-notes" placeholder="e.g. Relay responded correctly">
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-trip-test">Submit Test</button>
              </div>
            </div>

            <!-- 11. SF6 Pressure Test Form -->
            <div class="test-form" id="sf6-test-form">
              <div class="form-header">
                <h3><i class="fas fa-wind"></i> SF6/Gas Pressure Check</h3>
                <p>Ensure appropriate pressure and detect leakage</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="SF6 Gas Density Monitor" readonly>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Pressure (bar)</label>
                  <input type="number" id="sf6-pressure" step="0.1" placeholder="e.g. 6.2">
                </div>
                <div class="form-group">
                  <label>Temperature (¬∞C)</label>
                  <input type="number" id="sf6-temp" placeholder="e.g. 25">
                </div>
              </div>
              <div class="form-group">
                <label>Leakage Detected?</label>
                <select id="sf6-leakage">
                  <option value="No">No</option>
                  <option value="Yes">Yes</option>
                </select>
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-sf6-test">Submit Test</button>
              </div>
            </div>

            <!-- 12. Accuracy Test Form -->
            <div class="test-form" id="accuracy-test-form">
              <div class="form-header">
                <h3><i class="fas fa-tachometer-alt"></i> Accuracy Test</h3>
                <p>Verify meter reading accuracy against known loads</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="Phantom Load Tester" readonly>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Reference kWh</label>
                  <input type="number" id="accuracy-ref" step="0.001" value="1.000">
                </div>
                <div class="form-group">
                  <label>Meter kWh</label>
                  <input type="number" id="accuracy-meter" step="0.001" value="1.002">
                </div>
              </div>
              <div class="form-group">
                <label>Calculated Error (%)</label>
                <input type="text" id="accuracy-error" readonly placeholder="Auto-calculated">
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-accuracy-test">Submit Test</button>
              </div>
            </div>

            <!-- 13. Starting Current Test Form -->
            <div class="test-form" id="starting-test-form">
              <div class="form-header">
                <h3><i class="fas fa-bolt"></i> Starting Current Test</h3>
                <p>Check if meter starts registering at low load current</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="Low current source" readonly>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Starting Current (A)</label>
                  <input type="number" id="starting-current" step="0.01" value="0.02">
                </div>
                <div class="form-group">
                  <label>Time to Register (s)</label>
                  <input type="number" id="starting-time" value="10">
                </div>
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-starting-test">Submit Test</button>
              </div>
            </div>

            <!-- 14. Creep Test Form -->
            <div class="test-form" id="creep-test-form">
              <div class="form-header">
                <h3><i class="fas fa-pause-circle"></i> Creep Test</h3>
                <p>Check for movement without load (fraud prevention)</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="Test bench" readonly>
              </div>
              <div class="form-group">
                <label>No Movement Observed for (min)</label>
                <input type="number" id="creep-duration" value="15">
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-creep-test">Submit Test</button>
              </div>
            </div>

            <!-- 15. Cable IR Test Form -->
            <div class="test-form" id="cable-ir-test-form">
              <div class="form-header">
                <h3><i class="fas fa-shield-alt"></i> Cable Insulation Test</h3>
                <p>Detect insulation degradation between conductor and earth</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="5kV Megger" readonly>
              </div>
              <div class="form-group">
                <label>IR Value (MŒ©)</label>
                <input type="number" id="cable-ir-value" value="1500">
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-cable-ir-test">Submit Test</button>
              </div>
            </div>

            <!-- 16. Hi-Pot Test Form -->
            <div class="test-form" id="hi-pot-test-form">
              <div class="form-header">
                <h3><i class="fas fa-bolt"></i> High Voltage Test (Hi-Pot)</h3>
                <p>Assess dielectric strength of cable insulation</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="AC/DC Hipot Tester" readonly>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Applied Voltage (kV)</label>
                  <input type="number" id="hi-pot-voltage" value="15">
                </div>
                <div class="form-group">
                  <label>Leakage Current (¬µA)</label>
                  <input type="number" id="hi-pot-leakage" value="3">
                </div>
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-hi-pot-test">Submit Test</button>
              </div>
            </div>

            <!-- 17. Continuity Test Form -->
            <div class="test-form" id="continuity-test-form">
              <div class="form-header">
                <h3><i class="fas fa-plug"></i> Continuity Test</h3>
                <p>Ensure conductors are not open-circuited</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="Multimeter" readonly>
              </div>
              <div class="form-group">
                <label>All Conductors Continuous?</label>
                <select id="continuity-result">
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-continuity-test">Submit Test</button>
              </div>
            </div>

            <!-- 18. Phase ID Test Form -->
            <div class="test-form" id="phase-id-test-form">
              <div class="form-header">
                <h3><i class="fas fa-random"></i> Phase Identification Test</h3>
                <p>Verify phase sequence and correct identification</p>
              </div>
              <div class="form-group">
                <label>Equipment Used</label>
                <input type="text" value="Phase Sequence Meter" readonly>
              </div>
              <div class="form-group">
                <label>Identified Sequence</label>
                <input type="text" id="phase-sequence" value="A-B-C">
              </div>
              <div class="form-actions">
                <button class="btn-test btn-outline">Cancel</button>
                <button class="btn-test btn-primary" id="submit-phase-id-test">Submit Test</button>
              </div>
            </div>
          </div>

          <!-- Test Report View -->
          <div id="test-report-view" class="hidden">
            <div class="back-btn" id="back-to-report-tests">
              <i class="fas fa-arrow-left"></i> Back to Tests
            </div>
            <div class="test-report active" id="ir-test-report">
              <div class="report-header">
                <h3>Test Report: Insulation Resistance Test</h3>
                <p>Test performed on: <span id="report-date">June 15, 2023 10:30 AM</span></p>
              </div>
              <div class="report-details">
                <table>
                  <tr><th>Test Purpose</th><td>Assess insulation between windings and earth</td></tr>
                  <tr><th>Equipment Used</th><td>Megger insulation tester (5kV)</td></tr>
                  <tr><th>Test Location</th><td>KEDCO Substation 12, Transformer T-4</td></tr>
                  <tr><th>Test Engineer</th><td>Engr. Hussaini D. G</td></tr>
                </table>
              </div>
              <div class="report-results">
                <h4>Test Results</h4>
                <div class="result-item"><span class="result-label">Test Voltage</span><span class="result-value">5.0 kV</span></div>
                <div class="result-item"><span class="result-label">Ambient Temp</span><span class="result-value">28¬∞C</span></div>
                <div class="result-item"><span class="result-label">HV to Earth</span><span class="result-value">2.5 GŒ©</span></div>
                <div class="result-item"><span class="result-label">LV to Earth</span><span class="result-value">1.8 GŒ©</span></div>
                <div class="result-item"><span class="result-label">HV to LV</span><span class="result-value">3.2 GŒ©</span></div>
              </div>
              <div class="report-conclusion">
                <h4>Interpretation</h4>
                <p>All measured insulation values exceed minimum acceptable thresholds. No evidence of degradation or moisture intrusion.</p>
              </div>
              <div class="report-status status-pass"><i class="fas fa-check-circle"></i> TEST PASSED</div>
              <div class="report-actions">
                <button class="btn-test btn-outline" id="cancel-report"><i class="fas fa-times"></i> Cancel</button>
                <button class="btn-test btn-primary" id="print-report"><i class="fas fa-print"></i> Print Report</button>
              </div>
            </div>
            <!-- Reports for other tests will be dynamically generated -->
          </div>
        </section>

        <!-- TROUBLE REPORTS (ASSIGNMENT) -->
        <section id="trouble" class="view" style="display:none">
          <div class="card"><div class="muted">Trouble Reports (Assign personnel)</div>
            <table id="tblTR"><thead><tr><th>Req#</th><th>Region</th><th>Issue</th><th>Asset</th><th>Severity</th><th>Reported By</th><th>Time</th><th>Assign</th></tr></thead><tbody></tbody></table>
          </div>
        </section>

        <!-- TRY REQUESTS -->
        <section id="tryreq" class="view" style="display:none">
          <div class="card"><div class="muted">Transformer Try Requests (Approve/Reject)</div>
            <table id="tblTRY"><thead><tr><th>Req#</th><th>Feeder</th><th>Relay Indication</th><th>Risk</th><th>By</th><th>Time</th><th>Action</th></tr></thead><tbody></tbody></table>
          </div>
        </section>

        <footer>KEDCO PC&M ‚Äî Dashboard demo ‚Ä¢ Dark green & gold theme ‚Ä¢ Real-time sample data ‚Ä¢ <span id="footerTime"></span></footer>
      </main>
    </div>

    <div style="padding:12px 22px; text-align:center; color:var(--muted); font-size:12px;">
      Built for demo ‚Äî keep for presentation or expand to backend integration.
    </div>
  </div>

<script>
(function(){
  'use strict';

  // Helpers
  const $ = (s, ctx=document) => ctx.querySelector(s);
  const $$ = (s, ctx=document) => Array.from(ctx.querySelectorAll(s));
  const rand = (a,b) => Math.floor(Math.random()*(b-a+1))+a;
  const chance = p => Math.random()<p;
  const uid = ()=>Math.random().toString(36).slice(2,8).toUpperCase();
  const now = ()=>{ const d=new Date(); return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0')+':'+d.getSeconds().toString().padStart(2,'0'); };

  // State
  const state = { sound:true, log:[], protection:[], control:[], metering:[], equipment:[], approvals:{ TRY:[], TR:[] } };

  // Teams for assignment
  const teams = ['Regional PC&M','Regional Engineer','Rapid Response HQ Team','General PC&M Team'];

  // Basic lists
  const feeders=['Ahmadu Bello 11kV','Dawanau 33kV','BUK 33kV','Zaria Road 33kV','Hotoro 11kV','Bichi 33kV'];
  const devices=['OC Relay','EF Relay','Recloser','Sectionalizer','CB 33kV','City 11kV'];
  const actions=['Open ACB','Transfer Load','Restore Feeder','Isolate Fault','Changeover','Reclose'];
  const regions=['Kano','Katsina','Jigawa','Dutse','Bichi','Dambatta'];
  const issues=['Transformer Tripping','Breaker Lockout','Low DC Voltage','Low Oil Level','High Temperature'];
  const relayInd=['Overcurrent','Earth Fault','Restricted Earth Fault','Differential','Under Voltage'];
  const risk=['Low','Medium','High'];

  // DOM elements guards
  const el = id => document.getElementById(id);

  // Clock
  function tick(){ try{ const c = el('clock'); const t = el('topClock'); const f = el('footerTime'); const d = new Date(); const s = d.toLocaleString(); if(c) c.textContent = s; if(t) t.textContent = s; if(f) f.textContent = s; }catch(e){ console.warn('tick failed',e); }}
  setInterval(tick,1000); tick(); if(el('year')) el('year').textContent = new Date().getFullYear();

  // NAV
  $$('.nav-btn').forEach(b=>b.addEventListener('click', ()=>{
    $$('.nav-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const tgt = b.dataset.target;
    $$('.view').forEach(v=> v.style.display = (v.id===tgt) ? '' : 'none');
  }));

  // SOUND
  $('#toggleSound').addEventListener('click', ()=>{ state.sound = !state.sound; $('#toggleSound').innerHTML = `${state.sound? 'üîä':'üîá'} Sound: ${state.sound? 'ON':'OFF'}`; });

  function speak(text){ try{ if(!state.sound) return; if(window.speechSynthesis){ const u=new SpeechSynthesisUtterance(text); u.rate=1.02; window.speechSynthesis.speak(u); } }catch(e){ console.warn('speak failed', e); }}

  // LOG (not shown in UI now but available)
  function addLog(actor, action, detail){ try{ const row = {time: now(), actor, action, detail}; state.log.unshift(row); }catch(e){console.warn('addLog',e);} }

  // TABLE adders
  function addProtection(){ try{
    const tbody = el('tblProtection').querySelector('tbody'); if(!tbody) return;
    const row = {time: now(), feeder: feeders[rand(0,feeders.length-1)], device: devices[rand(0,devices.length-1)], event: chance(.6)?'Trip Cleared':'Trip Registered', status: chance(.7)?'ok': (chance(.5)?'warn':'bad')};
    state.protection.unshift(row);
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${row.time}</td><td>${row.feeder}</td><td>${row.device}</td><td>${row.event}</td><td><span class="status ${row.status}">${row.status.toUpperCase()}</span></td>`;
    tbody.prepend(tr);
    updateKPIs();
  }catch(e){console.warn('addProtection',e);} }

  function addControl(){ try{
    const tbody = el('tblControl').querySelector('tbody'); if(!tbody) return;
    const row={time: now(), loc: feeders[rand(0,feeders.length-1)].replace('11kV','SS').replace('33kV','SS'), action: actions[rand(0,actions.length-1)], op: ['Engr. Musa','Engr. Hauwa','Engr. John','Engr. Zainab'][rand(0,3)], status: chance(.7)?'ok':'warn'};
    state.control.unshift(row);
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${row.time}</td><td>${row.loc}</td><td>${row.action}</td><td>${row.op}</td><td><span class="status ${row.status}">${row.status==='ok'?'EXECUTED':'QUEUED'}</span></td>`;
    tbody.prepend(tr);
    updateKPIs();
  }catch(e){console.warn('addControl',e);} }

  function addMeter(){ try{
    const tbody = el('tblMetering').querySelector('tbody'); if(!tbody) return;
    const row={time:now(), id:'MT-'+uid(), customer:['Dangote Rice Mill','AKTH','KEDCO HQ','Bayero Univ','Max Stores'][rand(0,4)], test: chance(.5)?'Accuracy @ Ib':'Creep Test', result: chance(.86)?'ok':'bad'};
    state.metering.unshift(row);
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${row.time}</td><td>${row.id}</td><td>${row.customer}</td><td>${row.test}</td><td><span class="status ${row.result}">${row.result==='ok'?'PASS':'FAIL'}</span></td>`;
    tbody.prepend(tr);
    updateKPIs();
  }catch(e){console.warn('addMeter',e);} }

  function addEquipment(){ try{
    const tbody = el('tblEq').querySelector('tbody'); if(!tbody) return;
    const names=['Relay Tester','Primary Injection Kit','Insulation Tester','CT Analyzer','VT Set'];
    const row={name:names[rand(0,names.length-1)], asset:'EQ-'+uid(), loc:['Hotoro','Zaria Rd','BUK','Bichi'][rand(0,3)], status:['ok','warn','bad'][rand(0,2)], updated: now()};
    state.equipment.unshift(row);
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${row.name}</td><td>${row.asset}</td><td>${row.loc}</td><td><span class="status ${row.status}">${row.status==='ok'?'Available':row.status==='warn'?'In Use':'Faulty'}</span></td><td>${row.updated}</td>`;
    tbody.prepend(tr);
    updateKPIs();
  }catch(e){console.warn('addEquipment',e);} }

  // Trouble Reports - assignment (Head PC&M assigns teams)
  function addTrouble(){ try{
    const tbody = el('tblTR').querySelector('tbody'); if(!tbody) return;
    const row = { id:'TR-'+uid(), region: regions[rand(0,regions.length-1)], issue: issues[rand(0,issues.length-1)], asset: chance(.6)?'Transformer':'Breaker', severity: ['Low','Medium','High'][rand(0,2)], by:['Engr. Aisha','Engr. Bello','Engr. Chinedu'][rand(0,2)], time: now(), assigned: '' };
    state.approvals.TR.unshift(row);
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${row.id}</td><td>${row.region}</td><td>${row.issue}</td><td>${row.asset}</td><td><span class="status ${row.severity==='High'?'bad':row.severity==='Medium'?'warn':'ok'}">${row.severity}</span></td><td>${row.by}</td><td>${row.time}</td><td><select class="assignSelect">${teams.map(t=>`<option value="${t}">${t}</option>`).join('')}</select><button class="pill assign">Assign</button></td>`;
    tbody.prepend(tr);
    // hook assign
    const assignBtn = tr.querySelector('button.assign'); const sel = tr.querySelector('select.assignSelect');
    if(assignBtn){
      assignBtn.addEventListener('click', ()=>{
        const team = sel.value;
        row.assigned = team;
        speak(`Assigned ${row.id} to ${team}`);
        addLog('Head PC&M','Assigned',`${row.id} ‚Üí ${team}`);
        // visually show assignment
        const td = document.createElement('td');
        td.innerHTML = `<strong style="color:var(--gold)">${team}</strong>`;
        assignBtn.disabled=true; sel.disabled=true;
        tr.appendChild(td);
        updateKPIs();
        updateCharts();
      });
    }
    updateKPIs();
    updateCharts();
  }catch(e){console.warn('addTrouble',e);} }

  // TRY requests - approve/reject
  function addTRY(){ try{
    const tbody = el('tblTRY').querySelector('tbody'); if(!tbody) return;
    const row = { id:'TRY-'+uid(), feeder: feeders[rand(0,feeders.length-1)], relay: relayInd[rand(0,relayInd.length-1)], risk: risk[rand(0,risk.length-1)], by:['Engr. Maryam','Engr. Sola','Engr. Kabiru'][rand(0,2)], time: now(), status:'' };
    state.approvals.TRY.unshift(row);
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${row.id}</td><td>${row.feeder}</td><td>${row.relay}</td><td><span class="status ${row.risk==='High'?'bad':row.risk==='Medium'?'warn':'ok'}">${row.risk}</span></td><td>${row.by}</td><td>${row.time}</td><td class="actions"><button class="pill approve" data-id="${row.id}">Approve</button><button class="pill reject" data-id="${row.id}">Reject</button></td>`;
    tbody.prepend(tr);
    // hook approve/reject
    tr.querySelector('button.approve').addEventListener('click', ()=>{
      row.status='APPROVED';
      speak(`Try request ${row.id} approved`);
      addLog('Head O&M','Approved TRY',row.id);
      tr.style.opacity='.6';
      tr.querySelectorAll('button').forEach(b=>b.disabled=true);
      const td=document.createElement('td'); td.innerHTML = `<span class="status ok">APPROVED</span>`; tr.appendChild(td);
      updateKPIs();
      updateCharts();
    });
    tr.querySelector('button.reject').addEventListener('click', ()=>{
      row.status='REJECTED';
      speak(`Try request ${row.id} rejected`);
      addLog('Head O&M','Rejected TRY',row.id);
      tr.style.opacity='.6';
      tr.querySelectorAll('button').forEach(b=>b.disabled=true);
      const td=document.createElement('td'); td.innerHTML = `<span class="status bad">REJECTED</span>`; tr.appendChild(td);
      updateKPIs();
      updateCharts();
    });
    updateKPIs();
    updateCharts();
  }catch(e){console.warn('addTRY',e);} }

  // KPI updater
  function updateKPIs(){ try{
    if(el('kpiHealthy')) el('kpiHealthy').textContent = Math.max(30, 50 - state.protection.length);
    if(el('kpiIncidents')) el('kpiIncidents').textContent = state.protection.length + state.control.length + state.metering.length;
    if(el('kpiPending')) el('kpiPending').textContent = state.approvals.TR.length + state.approvals.TRY.length;
  }catch(e){console.warn('updateKPIs',e);} }

  // Charts
  let tripsChart = null, equipChart = null, severityChart = null, regionChart = null;
  function initCharts(){ try{
    if(typeof Chart === 'undefined'){ console.warn('Chart.js missing ‚Äî charts disabled'); return; }
    const ctx = $('#chartTrips'); const ectx = $('#chartEquip'); const sctx = $('#chartSeverity'); const rctx = $('#chartRegion');
    if(ctx){
      tripsChart = new Chart(ctx.getContext('2d'), {
        type:'line',
        data:{ labels: Array.from({length:12}, (_,i)=>i+1),
          datasets:[{ label:'Trips', data: Array.from({length:12}, ()=>rand(0,6)), tension:0.3, borderColor: 'rgba(255,212,77,0.95)', backgroundColor:'rgba(255,212,77,0.12)', fill:true }]},
        options:{ plugins:{legend:{display:false}}, scales:{x:{display:false}}, animation:{duration:400} }
      });
    }
    if(ectx){
      equipChart = new Chart(ectx.getContext('2d'), {
        type:'bar',
        data:{ labels:['Relay','Primary Inj.','Insulation','CT Analyzer'], datasets:[{ label:'Availability %', data: [rand(60,95),rand(50,95),rand(60,98),rand(50,95)], backgroundColor:'rgba(19,179,107,0.9)'}]},
        options:{ plugins:{legend:{display:false}}, scales:{y:{min:0,max:100}}, animation:{duration:400} }
      });
    }
    if(sctx){
      severityChart = new Chart(sctx.getContext('2d'), {
        type:'pie',
        data:{ labels:['Low','Medium','High'], datasets:[{ data:[0,0,0], backgroundColor:['rgba(19,179,107,0.85)','rgba(255,212,77,0.85)','rgba(231,76,60,0.85)']}]},
        options:{ plugins:{legend:{position:'bottom'}} }
      });
    }
    if(rctx){
      regionChart = new Chart(rctx.getContext('2d'), {
        type:'bar',
        data:{ labels: regions.slice(), datasets:[{ label:'Reports', data: regions.map(()=>0), backgroundColor:'rgba(255,212,77,0.85)'}]},
        options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    }
  }catch(e){console.warn('initCharts failed',e);} }

  function updateCharts(){ try{
    // Trips chart: push a new sample and cap at 24
    if(tripsChart){
      tripsChart.data.labels.push(new Date().toLocaleTimeString());
      tripsChart.data.datasets[0].data.push(rand(0,6));
      if(tripsChart.data.labels.length>24){ tripsChart.data.labels.shift(); tripsChart.data.datasets[0].data.shift(); }
      tripsChart.update('none');
    }
    // Equip chart: randomize availabilities
    if(equipChart){
      equipChart.data.datasets[0].data = equipChart.data.datasets[0].data.map(()=> rand(50,98));
      equipChart.update('none');
    }
    // Severity & Region: recompute from state.approvals.TR
    const sevCounts = {Low:0, Medium:0, High:0};
    const regCounts = regions.reduce((acc,r)=>{ acc[r]=0; return acc; }, {});
    state.approvals.TR.forEach(t=>{ if(t && t.severity) sevCounts[t.severity] = (sevCounts[t.severity]||0)+1; if(t && t.region) regCounts[t.region] = (regCounts[t.region]||0)+1; });
    // If charts exist update them
    if(severityChart){
      severityChart.data.datasets[0].data = [sevCounts.Low, sevCounts.Medium, sevCounts.High];
      severityChart.update('none');
    }
    if(regionChart){
      regionChart.data.datasets[0].data = regions.map(r => regCounts[r] || 0);
      regionChart.update('none');
    }
  }catch(e){console.warn('updateCharts',e);} }

  // Global search
  $('#globalSearch').addEventListener('input', e=>{
    const q = (e.target.value||'').toLowerCase();
    ['tblProtection','tblControl','tblMetering','tblEq','tblTR','tblTRY'].forEach(id=>{
      const t = el(id); if(!t) return;
      t.querySelectorAll('tbody tr').forEach(r=> r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none');
    });
  });

  // Buttons
  $('#btnSim').addEventListener('click', ()=>{ addProtection(); addControl(); addMeter(); addEquipment(); addTrouble(); addTRY(); updateKPIs(); updateCharts(); speak('New sample events generated'); });
  $('#simulate').addEventListener('click', ()=>{ $('#btnSim').click(); });

  // Periodic live updates
  setInterval(()=>{ if(chance(.6)) { addProtection(); updateKPIs(); updateCharts(); } }, 6000);
  setInterval(()=>{ if(chance(.5)) { addControl(); updateKPIs(); } }, 8000);
  setInterval(()=>{ if(chance(.5)) { addMeter(); updateKPIs(); } }, 9000);
  setInterval(()=>{ if(chance(.45)) { addEquipment(); updateKPIs(); updateCharts(); } }, 11000);
  setInterval(()=>{ if(chance(.35)) { addTrouble(); updateKPIs(); speak('New trouble report'); } }, 12000);
  setInterval(()=>{ if(chance(.35)) { addTRY(); updateKPIs(); speak('New transformer try request'); } }, 13000);

  // Init seed
  function seed(){ for(let i=0;i<6;i++){ addProtection(); addControl(); addMeter(); addEquipment(); } for(let i=0;i<3;i++){ addTrouble(); addTRY(); } updateKPIs(); initCharts(); updateCharts(); }
  seed();

})();

// Test Equipment Script (from Code 1)
document.addEventListener('DOMContentLoaded', function() {
    const dashboardView = document.getElementById('dashboard-view');
    const testCategoryView = document.getElementById('test-category-view');
    const testFormView = document.getElementById('test-form-view');
    const testReportView = document.getElementById('test-report-view');

    const newTestBtn = document.getElementById('new-test-btn');
    const backToDashboard = document.getElementById('back-to-dashboard');
    const backToTests = document.getElementById('back-to-tests');
    const backToReportTests = document.getElementById('back-to-report-tests');
    const printReportBtn = document.getElementById('print-report');
    const cancelReportBtn = document.getElementById('cancel-report');

    const categoryCards = document.querySelectorAll('.category-card');
    const testItems = document.querySelectorAll('.test-item');

    // Show dashboard initially
    showView(dashboardView);

    // Navigation
    newTestBtn.addEventListener('click', () => showView(testCategoryView));
    backToDashboard.addEventListener('click', () => showView(dashboardView));
    backToTests.addEventListener('click', () => showView(testCategoryView));
    backToReportTests.addEventListener('click', () => showView(testCategoryView));
    cancelReportBtn.addEventListener('click', () => showView(testCategoryView));
    printReportBtn.addEventListener('click', () => window.print());

    // Category selection
    categoryCards.forEach(card => {
        card.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            document.querySelectorAll('.test-selection').forEach(el => el.classList.remove('active'));
            document.getElementById(`${category}-tests`).classList.add('active');
            showView(testCategoryView);
        });
    });

    // Test selection
    testItems.forEach(item => {
        item.addEventListener('click', function() {
            const test = this.getAttribute('data-test');
            document.querySelectorAll('.test-form').forEach(el => el.classList.remove('active'));
            document.getElementById(`${test}-form`).classList.add('active');
            showView(testFormView);
        });
    });

    // Submit Handlers
    document.getElementById('submit-ir-test').addEventListener('click', function() {
        const voltage = document.getElementById('ir-voltage').value || '5.0';
        const temp = document.getElementById('ir-temp').value || '28';
        const hvEarth = document.getElementById('ir-hv-earth').value || '2500';
        const lvEarth = document.getElementById('ir-lv-earth').value || '1800';
        const hvLv = document.getElementById('ir-hv-lv').value || '3200';

        generateReport('ir-test-report', 'Insulation Resistance Test', [
            ['Test Voltage', `${voltage} kV`],
            ['Ambient Temperature', `${temp}¬∞C`],
            ['HV to Earth', `${hvEarth} MŒ©`],
            ['LV to Earth', `${lvEarth} MŒ©`],
            ['HV to LV', `${hvLv} MŒ©`]
        ], 'All insulation values are above 1 GŒ©, indicating excellent insulation condition.', true);
    });

    document.getElementById('submit-ttr-test').addEventListener('click', function() {
        const nominal = document.getElementById('ttr-nominal').value || '11kV/415V';
        const primary = document.getElementById('ttr-primary').value || '11000';
        const secondary = document.getElementById('ttr-secondary').value || '415';
        const ratio = (primary / secondary).toFixed(2);
        const deviation = Math.abs(ratio - 26.46) < 0.5 ? 0.2 : 1.2;

        generateReport('ttr-test-report', 'Turns Ratio Test (TTR)', [
            ['Nominal Ratio', nominal],
            ['Primary Voltage', `${primary} V`],
            ['Secondary Voltage', `${secondary} V`],
            ['Measured Ratio', ratio],
            ['Deviation', `${deviation}%`]
        ], `Ratio deviation is within ¬±0.5%. Winding configuration is correct.`, deviation < 0.5);
    });

    document.getElementById('submit-winding-test').addEventListener('click', function() {
        const a = document.getElementById('winding-hv-a').value || '2.1';
        const b = document.getElementById('winding-hv-b').value || '2.1';
        const c = document.getElementById('winding-hv-c').value || '2.2';
        const balanced = Math.abs(a - b) < 0.2 && Math.abs(b - c) < 0.2;

        generateReport('winding-test-report', 'Winding Resistance Test', [
            ['HV-A', `${a} Œ©`],
            ['HV-B', `${b} Œ©`],
            ['HV-C', `${c} Œ©`]
        ], `Windings show ${balanced ? 'balanced' : 'unbalanced'} resistance. ${balanced ? 'No shorted turns detected.' : 'Possible inter-turn fault.'}`, balanced);
    });

    document.getElementById('submit-oil-test').addEventListener('click', function() {
        const t1 = parseFloat(document.getElementById('oil-test1').value) || 38;
        const t2 = parseFloat(document.getElementById('oil-test2').value) || 42;
        const t3 = parseFloat(document.getElementById('oil-test3').value) || 40;
        const avg = ((t1 + t2 + t3) / 3).toFixed(1);
        const pass = avg >= 30;

        generateReport('oil-test-report', 'Oil Dielectric Strength Test', [
            ['Test 1', `${t1} kV`],
            ['Test 2', `${t2} kV`],
            ['Test 3', `${t3} kV`],
            ['Average', `${avg} kV`]
        ], `Oil breakdown voltage is ${pass ? 'above' : 'below'} 30 kV standard. ${pass ? 'Oil is clean and dry.' : 'Oil may be contaminated.'}`, pass);
    });

    document.getElementById('submit-excitation-test').addEventListener('click', function() {
        const current = document.getElementById('excitation-current').value || '1.5';
        const loss = document.getElementById('excitation-loss').value || '110';
        const normal = current <= 2.0 && loss <= 150;

        generateReport('excitation-test-report', 'Magnetization/Excitation Test', [
            ['Excitation Current', `${current} A`],
            ['Core Loss', `${loss} W`]
        ], `Core performance is ${normal ? 'normal' : 'abnormal'}. ${normal ? 'No core saturation detected.' : 'Possible shorted laminations.'}`, normal);
    });

    document.getElementById('submit-vector-test').addEventListener('click', function() {
        const group = document.getElementById('vector-group').value || 'Dyn11';
        const shift = document.getElementById('vector-shift').value || '30';
        const correct = group === 'Dyn11' && shift == 30;

        generateReport('vector-test-report', 'Vector Group Test', [
            ['Measured Group', group],
            ['Phase Shift', `${shift}¬∞`]
        ], `Vector group is ${correct ? 'correctly verified' : 'incorrect'}. Phase displacement is ${correct ? 'as expected' : 'not matching nameplate'}.`, correct);
    });

    document.getElementById('submit-contact-test').addEventListener('click', function() {
        const a = document.getElementById('contact-a').value || '35';
        const b = document.getElementById('contact-b').value || '38';
        const c = document.getElementById('contact-c').value || '37';
        const max = Math.max(a, b, c);
        const pass = max <= 100;

        generateReport('contact-test-report', 'Contact Resistance Test', [
            ['Phase A', `${a} ¬µŒ©`],
            ['Phase B', `${b} ¬µŒ©`],
            ['Phase C', `${c} ¬µŒ©`]
        ], `Maximum contact resistance is ${max} ¬µŒ©. ${pass ? 'Within acceptable limits. Contacts are clean.' : 'Exceeds limit. Erosion suspected.'}`, pass);
    });

    document.getElementById('submit-timing-test').addEventListener('click', function() {
        const open = document.getElementById('timing-open').value || '58';
        const close = document.getElementById('timing-close').value || '62';
        const pass = open <= 80 && close <= 100;

        generateReport('timing-test-report', 'Timing Test (Open/Close)', [
            ['Open Time', `${open} ms`],
            ['Close Time', `${close} ms`]
        ], `Timing is ${pass ? 'within' : 'outside'} standard limits. ${pass ? 'No mechanical delay observed.' : 'Check mechanism.'}`, pass);
    });

    document.getElementById('submit-cb-ir-test').addEventListener('click', function() {
        const ir = document.getElementById('cb-ir-value').value || '1500';
        const pass = ir > 1000;

        generateReport('cb-ir-test-report', 'Insulation Resistance Test (CB)', [
            ['Insulation Resistance', `${ir} MŒ©`]
        ], `Insulation resistance is ${pass ? 'strong' : 'weak'}. ${pass ? 'Dielectric integrity confirmed.' : 'Moisture or contamination possible.'}`, pass);
    });

    document.getElementById('submit-trip-test').addEventListener('click', function() {
        const voltage = document.getElementById('trip-voltage').value || '110';
        const current = document.getElementById('trip-current').value || '12';
        const pass = voltage >= 80 && current <= 50;

        generateReport('trip-test-report', 'Trip Circuit Supervision Test', [
            ['Trip Voltage', `${voltage} V DC`],
            ['Trip Current', `${current} mA`]
        ], `Trip circuit is ${pass ? 'functional' : 'faulty'}. ${pass ? 'Supervision relay responded correctly.' : 'Check wiring or relay.'}`, pass);
    });

    document.getElementById('submit-sf6-test').addEventListener('click', function() {
        const pressure = document.getElementById('sf6-pressure').value || '6.2';
        const leakage = document.getElementById('sf6-leakage').value;
        const pass = pressure >= 5.5 && leakage === 'No';

        generateReport('sf6-test-report', 'SF6/Gas Pressure Check', [
            ['Pressure', `${pressure} bar`],
            ['Leakage Detected', leakage]
        ], `SF6 pressure is ${pass ? 'normal' : 'low'}. Leakage is ${leakage.toLowerCase()}. ${pass ? 'Safe for operation.' : 'Requires refill and leak check.'}`, pass);
    });

    document.getElementById('submit-accuracy-test').addEventListener('click', function() {
        const ref = parseFloat(document.getElementById('accuracy-ref').value) || 1.000;
        const meter = parseFloat(document.getElementById('accuracy-meter').value) || 1.002;
        const error = ((meter - ref) / ref * 100).toFixed(2);
        document.getElementById('accuracy-error').value = `${error}%`;
        const pass = Math.abs(error) <= 1.0;

        generateReport('accuracy-test-report', 'Accuracy Test', [
            ['Reference kWh', `${ref} kWh`],
            ['Meter kWh', `${meter} kWh`],
            ['Error', `${error}%`]
        ], `Meter accuracy is ${pass ? 'within' : 'outside'} ¬±1% limit. ${pass ? 'Meter is calibrated and accurate.' : 'Recalibration needed.'}`, pass);
    });

    document.getElementById('submit-starting-test').addEventListener('click', function() {
        const current = document.getElementById('starting-current').value || '0.02';
        const time = document.getElementById('starting-time').value || '10';
        const pass = current <= 0.05 && time <= 30;

        generateReport('starting-test-report', 'Starting Current Test', [
            ['Starting Current', `${current} A`],
            ['Register Time', `${time} s`]
        ], `Meter starts at ${current} A. ${pass ? 'Meets sensitivity requirement.' : 'Fails starting current test.'}`, pass);
    });

    document.getElementById('submit-creep-test').addEventListener('click', function() {
        const duration = document.getElementById('creep-duration').value || '15';
        const pass = duration >= 10;

        generateReport('creep-test-report', 'Creep Test', [
            ['No Movement Duration', `${duration} minutes`]
        ], `No movement observed for ${duration} minutes. ${pass ? 'No creep detected. Meter secure.' : 'Creep detected. Possible tampering.'}`, pass);
    });

    document.getElementById('submit-cable-ir-test').addEventListener('click', function() {
        const ir = document.getElementById('cable-ir-value').value || '1500';
        const pass = ir > 1000;

        generateReport('cable-ir-test-report', 'Cable Insulation Resistance Test', [
            ['IR Value', `${ir} MŒ©`]
        ], `Insulation is ${pass ? 'healthy' : 'degraded'}. ${pass ? 'No moisture or cracks detected.' : 'Inspect for damage.'}`, pass);
    });

    document.getElementById('submit-hi-pot-test').addEventListener('click', function() {
        const voltage = document.getElementById('hi-pot-voltage').value || '15';
        const leakage = document.getElementById('hi-pot-leakage').value || '3';
        const pass = leakage < 10;

        generateReport('hi-pot-test-report', 'High Voltage Test (Hi-Pot)', [
            ['Applied Voltage', `${voltage} kV`],
            ['Leakage Current', `${leakage} ¬µA`]
        ], `Cable insulation withstood ${voltage} kV. Leakage current is ${leakage} ¬µA. ${pass ? 'No puncture or breakdown occurred.' : 'Insulation failure suspected.'}`, pass);
    });

    document.getElementById('submit-continuity-test').addEventListener('click', function() {
        const result = document.getElementById('continuity-result').value;
        const pass = result === 'Yes';

        generateReport('continuity-test-report', 'Continuity Test', [
            ['Conductors Continuous', result]
        ], `All cores are ${pass ? 'electrically continuous end-to-end.' : 'open-circuited. Check connections.'}`, pass);
    });

    document.getElementById('submit-phase-id-test').addEventListener('click', function() {
        const sequence = document.getElementById('phase-sequence').value || 'A-B-C';
        const pass = sequence === 'A-B-C';

        generateReport('phase-id-test-report', 'Phase Identification Test', [
            ['Identified Sequence', sequence]
        ], `Phase markings are ${pass ? 'correctly identified and labeled.' : 'incorrect. Recheck connections.'}`, pass);
    });

    function generateReport(reportId, testName, results, conclusion, passed) {
        // Hide all reports
        document.querySelectorAll('.test-report').forEach(r => r.classList.remove('active'));

        let report = document.getElementById(reportId);
        if (!report) {
            report = document.createElement('div');
            report.className = 'test-report';
            report.id = reportId;
            document.getElementById('test-report-view').appendChild(report);
        }

        let resultsHtml = '';
        results.forEach(r => {
            resultsHtml += `<div class="result-item"><span class="result-label">${r[0]}</span><span class="result-value">${r[1]}</span></div>`;
        });

        report.innerHTML = `
            <div class="report-header">
                <h3>Test Report: ${testName}</h3>
                <p>Test performed on: <span>${new Date().toLocaleString()}</span></p>
            </div>
            <div class="report-details">
                <table>
                    <tr><th>Test Purpose</th><td>See test standard</td></tr>
                    <tr><th>Test Engineer</th><td>Engr. Abdullahi Musa</td></tr>
                </table>
            </div>
            <div class="report-results">
                <h4>Test Results</h4>
                ${resultsHtml}
            </div>
            <div class="report-conclusion">
                <h4>Conclusion</h4>
                <p>${conclusion}</p>
            </div>
            <div class="report-status ${passed ? 'status-pass' : 'status-fail'}">
                <i class="fas fa-${passed ? 'check' : 'times'}-circle"></i> TEST ${passed ? 'PASSED' : 'FAILED'}
            </div>
            <div class="report-actions">
                <button class="btn-test btn-outline" onclick="showView(document.getElementById('test-category-view'))"><i class="fas fa-times"></i> Cancel</button>
                <button class="btn-test btn-primary" onclick="window.print()"><i class="fas fa-print"></i> Print Report</button>
            </div>
        `;

        report.classList.add('active');
        showView(testReportView);
    }

    function showView(view) {
        [dashboardView, testCategoryView, testFormView, testReportView].forEach(v => v.classList.add('hidden'));
        view.classList.remove('hidden');
    }
});
</script>
</body>
</html>